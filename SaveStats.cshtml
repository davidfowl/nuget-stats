@using (var db = Database.Open("Stats")) {
    DateTime? lastLog = db.QueryValue("Select top 1 LogTime from Stats order by LogTime desc");
    if (lastLog.HasValue && DateTime.UtcNow.Subtract(lastLog.Value).TotalMinutes < 45) {
        return;
    }
    
    var packages = PackageRepository.GetPackages(Cache);
    
    db.Execute("Insert into Stats (LogTime, Downloads, UniquePackages, TotalPackages) values (@0, @1, @2, @3)",
        DateTime.UtcNow, 
        packages.GroupBy(p => p.Id).Select(g => g.First().DownloadCount).Sum(),
        packages.GroupBy(p => p.Id).Count(), 
        packages.Count());
}
